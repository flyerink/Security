<!--
  时尚指南
  - 确保尽可能将所有内容包装到 80 列。
  - 句末句点后跟两个空格。
  - 十六进制整数应格式化为“0xff”。
-->

Cerberus 项目：固件挑战规范
=====

作者：
- 微软首席固件工程经理 Bryan Kelly
- Christopher Weimer，微软高级固件工程师
- Akram Hamdy，微软固件工程师

## 修订记录

- v0.01 (2017-08-28)
    - 初稿。
- v0.02 (2017-09-28)
    - 添加参考部分。
- v0.03 (2017-10-28)
    - 将消息交换从协议转移到基于寄存器。
- v0.04 (2018-12-02)
    - 添加 MCTP 支持和更新会话
- v0.05 (2018-30-04)
    - 纳入供应商反馈。
- v0.06 (2018-15-10)
    - 更新身份验证流程。
    - 将测量更改为 PMR 和认证集成。
- v0.07 (2019-10-01)
    - 由于对扩展的静态要求，将 PMR 命名更改为 PM。
- v0.08 (2019-15-02)
    - 添加固件恢复图像更新命令。
    - 澄清错误响应。
- v0.09 (2019-26-06)
    - 添加重置配置命令。
    - 识别受加密超时影响的命令。
- v0.10 (2019-05-08)
    - 更新 Cerberus 定义的 MCTP 消息定义。
- v0.11 (2019-21-10)
    - 添加有关设备制造商配对的详细信息。
    - 添加命令以获取 RIoT、芯片和主机重置信息。
- v0.12 (2019-27-12)
    - 关于必需和可选命令的说明。
- v0.13 (2020-17-03)
    - 添加命令以获取清单平台 ID 和 PMR 测量数据。
    - 更新开封和设备功能命令。
    - 对命令包格式的澄清。
    - 添加日志格式。
- v0.14 (2020-30-04)
    - 多个命令的更新格式，添加扩展更新状态。
    - 对证书的澄清。
    - 添加有关加密消息的详细信息。
- v0.15 (2020-22-05)
    - 添加解封 ECDH 种子参数。
    - 定义一系列保留命令。
- v1.00 (2020-19-08)
    - 更新会话建立和安全设备绑定。
    - 添加回 Rq 位。

(c) 2017 年微软公司。

## 合法的

截至 2017 年 11 月 1 日，以下人员或实体已将此
Open Web Foundation Final Specification 下可用的规范
协议 (OWFa 1.0)，可在
<http://www.openwebfoundation.org/legal/the-owf-1-0-agreements/owfa-1-0>。

- 微软公司。

您可以查看 Open Web Foundation Agreement Version 的签名副本
本规范的 1.0 在<http://www.opencompute.org/participate/legal-documents/> 其中可能还包括上面所列的其他缔约方。

您对本规范的使用可能受其他第三方权利的约束。这规范“按原样”提供。贡献者明确否认任何保证（明示、暗示或其他方式），包括暗示的保证适销性、非侵权、特定用途的适用性或所有权，规范相关。实施或其他方面的全部风险规范实施者和用户假定使用规范。在在任何情况下，任何一方均不对任何其他方的利润损失或任何任何性质的间接、特殊、偶然或后果性损害的形式来自与本规范或其相关的任何类型的诉讼管理协议，无论是基于违反合同、侵权行为（包括疏忽），或其他，以及是否已通知另一方这种损害的可能性。

本规范的贡献者和许可者可能提到了某些仅在本规范中引用而非引用的技术
根据 OWF CLA 或 OWFa 获得许可。以下是仅供参考的清单技术：智能平台管理界面（IPMI）；I2C 是NXP SEMICONDUCTORS 的商标和技术；EPYC 是一个商标，并且先进微设备公司的技术；ASPEED AST 2400/2500 系列处理器是 Aspeed Technology Inc. 的一项技术；MOLEX NANOPITCH, 纳米PICOBLADE、MINI-FIT JR 和相关连接器是商标，并且MOLEX LLC 的技术；WINBOND 是 WINBOND ELECTRONICS 的商标公司; NVLINK 是 NVIDIA 的一项技术；英特尔至强可扩展处理器，英特尔 QUICKASSIST 技术、英特尔超线程技术、增强型英特尔SPEEDSTEP 技术、英特尔虚拟化技术、英特尔服务器平台服务、英特尔可管理性引擎和英特尔可信执行技术是英特尔公司的商标和技术；SITARA ARM CORTEX-A9 处理器是德州仪器的商标和技术；来自 PENCOM 的导销；
松下电池。这些技术的实施可能受制于遵守他们自己的法律条款。


# 概括

在本文档中，术语“处理器”是指所有中央处理器单元 (CPU)、片上系统 (SOC)、微控制单元 (MCU) 和微处理器架构。该文件详细说明了所需的挑战协议用于主动组件和平台 RoT。处理器必须实现所有建立基于硬件的信任根所需的功能。处理器本质上不能满足这些要求必须实施闪存保护 Cerberus RoT 描述了物理闪存保护要求文档。

活动组件是包含处理器的附加卡和外围设备，运行软逻辑的微控制器或设备。

本文档描述了用于证明测量的协议平台活动 RoT 的固件。该规范包括平台固件的预启动、启动和运行时挑战和验证正直。分层架构超越了典型的 UEFI
测量，包括所有有源组件的完整性测量固件。该文档描述了支持证明所需的 API塞伯鲁斯计划的挑战。


# 物理通信通道

典型的云服务器主板布局具有 I2C 总线路由到所有活动成分。这些 I2C 总线通常由底板管理使用用于有源组件热监控的控制器 (BMC)。在里面Cerberus 板布局，I2C 通道首先由 Cerberus 平台使用微控制器在引导和预引导期间，然后多路复用器切换回BMC 用于热管理。Cerberus 可以随时请求 BMC运行时挑战和证明的收益控制。Cerberus 控制 I2C多路复用位置，并在运行时协调访问。也可以用于Cerberus 在运行时通过 BMC 代理命令，带有链接选项加密和非对称密钥交换，使 BMC 对通讯。主板上的 Cerberus 微控制器被称为作为平台主动信任根 (PA-RoT)。这个微控制器是头分层信任根平台设计并包含可证明的哈希
平台固件清单 (PFM) 中保存的所有平台固件和组件固件清单 (CFM)。

大多数云服务器主板将 I2C 路由到有源组件以进行散热监控，添加多路复用器逻辑是唯一的修改母板。添加额外多路复用器的替代方法是通过隧道安全通过 I2C 上的 BMC 挑战通道。一旦 BMC 被加载并且经 Cerberus 证明，它可以充当 I2C 代理。这种方法比较少
可取的，因为如果 BMC 失败，它会限制平台认证证明。在任何一种方法中，有源组件的物理连接器接口不需要更改，因为它们已经具有 I2C。

具有内在安全属性的活动组件
“Processor Secure Boot Requirements”文档不需要放置物理
Cerberus 微控制器位于其处理器和闪存之间。有源元件
不符合“处理器安全启动”中描述的要求
实施 Cerberus 微控制器需要“要求”文件
在他们的处理器和闪存之间建立所需的信任根。数字
1 主板I2C通道图，代表pre-boot和post-boot
主板 PA-RoT 和 Active 之间的测量挑战通道
组件 RoT (AC-RoT)。

> TODO：图 1

Project Cerberus 固件认证是一个分层架构。最多
现代服务器中的活动组件在启动之前启动到操作级别
平台的主机处理器完成初始化并能够
挑战设备。在 Cerberus 设计中，该平台位于
预上电或复位状态，从而有源组件被隔离和
挑战他们的固件测量。有源组件必须响应
来自 PA-RoT 的挑战在之前确认其固件的完整性
他们被解除隔离。

在这个版本的 Cerberus 平台设计中，PFM 和 CFM 是静态的。
清单可通过 PA-RoT 的通信接口进行编程。
有源元件的自动检测和 PFM/CFM 的计算将是
在规范的未来版本中考虑。PFM 和 CFM 是
允许的固件版本及其相应固件的清单
测量。清单包含用于限制的单调标识符
回滚。

PA-RoT 使用 CFM 中的测量来挑战有源组件
并比较他们的测量结果。PA-RoT 然后使用这些的摘要
measurements作为平台级别的measurements，创建一个层次化的平台
可以证明平台和活动组件完整性的级别摘要
固件。

PA-RoT 将支持身份验证、完整性和机密性
消息。有源组件 RoT (AC-RoT) 将支持身份验证和
消息和挑战的完整性。为此，需要 AC-RoT
支持证书认证。有源组件将支持
用于身份验证的组件唯一 CA 签名质询证书。

> 注意：I2C 是一种低速链路，两者之间存在性能折衷
> 优化协议消息和强大的加密哈希算法
> 携带更高的比特数。RoT 不支持证书
> 身份验证需要支持散列算法和 RSA 或
> 固件测量的 ECDSA 签名。


## 功率控制

在 Cerberus 主板设计中，电源和复位时序
由 PA-RoT 精心策划。当电压施加到主板时，它
通过浪涌电路到执行时间敏感的 CPLD
电源轨的排序，以确保稳定性。一旦电源良好水平
建立，该平台被认为是通电的。在初始通电
Cerberus 设计中的平台，唯一上电的有源组件是
PA-RoT。RoT 首先安全地加载和解压缩其内部固件，
然后验证底板管理控制器 (BMC) 固件的完整性
测量 BMC 闪存。当 BMC 固件已通过身份验证时，
Active RoT 可以为 BMC 供电。一旦 BMC 被
供电时，Active RoT 验证平台 UEFI 的固件，在
RoT 何时对 PCIe 插槽供电并开始有源组件
RoT挑战。当 UEFI 已通过身份验证时，平台将保留在
系统重置，Active RoT 将使系统保持重置状态，直到 AC-RoT 有
应对测量挑战。任何不响应的 PCIe 端口
他们的测量挑战将随后断电。如果任何
预期的有源组件无法响应测量挑战，
Cerberus 策略确定系统是否应使用 Active 启动
组件断电，或平台应保持备用电源，同时
通过以下方式向数据中心管理软件报告测量失败
OOB 路径。


# 沟通

Cerberus PA-RoT 通过 I2C 与 AC-RoT 通信。协议
支持身份验证和测量挑战。Cerberus PA-RoT
紧密生成微控制器独有的安全非对称密钥对
遵循 DICE 架构。私钥在外部无法访问
Cerberus RoT 的安全区域。密钥生成和链接遵循
RIoT 规范，在第 9.3 节 DICE 和 RIoT 密钥和
证书。派生平台别名公钥可用于
在挑战握手期间来自 AC-RoT 的证明和通信
用于建立通信。


## RSA/ECDSA 密钥生成

Cerberus 平台 Active RoT 应该支持设备标识符
组合引擎 (DICE) 架构。在 DICE 中，复合设备标识符
(CDI) 用作设备身份和认证的基础。钥匙
源自唯一设备秘密 (UDS) 和第一个可变的测量
代码用于微控制器内的数据保护和证明
上层固件。导出 Device Id 非对称密钥对
从 CDI 加密并与设备 ID 证书相关联。
CDI 使用从 PUF 和其他随机熵派生的 UDS，包括
微控制器唯一 ID 和固件安全描述符。

Cerberus 实现了用于证书生成和
证明。有关 DICE 和 RIoT 密钥生成的详细信息，请查看部分：
9.3 DICE 和 RIoT 密钥和证书。

注意：CDI 是基于 UDS，Microcontroller Security 的复合密钥
描述符和第二阶段引导加载程序（可变）测量。第二
阶段引导加载程序是可变代码，但通常不会随固件更新
更新。对第二阶段引导加载程序的更改将导致不同的结果
CDI，导致不同的非对称设备 ID 密钥生成。证书
与以前的设备密钥相关联的将失效和一个新的
证书需要签名。

第二个非对称密钥对证书在 RIoT 核心层创建
Cerberus 并传递给 Cerberus 应用程序固件。这个密钥对形式
别名证书，源自 CDI，Cerberus 固件安全
下一阶段 Cerberus 固件的描述符和测量。

CDI 派生私钥的知识证明，称为设备 ID 私有
密钥用作加密协议中的构建块以识别
设备。设备 ID 私钥用于签署别名证书，因此
验证密钥的完整性。在初始配置期间，设备 ID
证书是由 Microsoft 证书颁发机构签署的 CA。什么时候
配置后，设备 ID 密钥必须与先前签名的公钥相匹配。

> TODO：图 2

> 注意：CDI 和 Device Id 私钥在退出前被安全擦除
> 防暴核心。

软件的每一层都可以使用其私钥证书进行签名和发布
下一层的新证书，每个连续的层都继续这个
链。应用层的证书（Alias Certificate）可以是
在使用设备进行身份验证和建立安全通道时使用。这
证书还可以确定真实性。非应用层私钥
用于签署证书的层必须只能访问它们所在的层
产生。公钥被持久化或传递给上层，并且
最终与上下游实体交换。


## 链式测量

Cerberus 固件测量基于设备标识符
组合引擎 (DICE) 架构：
<https://trustedcomputinggroup.org/work-groups/dice-architectures>

RoT 上的第一个可变代码是第二引导加载程序 (SBL)。CDI 是一个
`HMAC（设备密钥 + 熵，H(SBL)`）的测量。这
测量然后传递到第二阶段引导加载程序，计算
第三引导加载程序 (TBL) 的摘要。在 Cerberus RoT 上，这是
应用程序固件：`HMAC(CDI, H(TBL))`。

> TODO：图 4

运行 Cerberus 应用程序固件的第三阶段引导加载程序 (TBL)
将对处理器的 SPI/QSPI 闪存进行额外的面积测量
它保护、测量活动区域和非活动区域。TBL测量
使用证明新鲜度种子进行验证和扩展。决赛
测量结果被签名、密封并提供给挑战软件。

应用程序固件证明固件的种子可以从
Cerberus 固件测量，或使用专用的别名证书
可以提供新鲜度种子来测量受保护的处理器固件。

测量值存储在固件或硬件寄存器值中
在 PA-RoT 内。种子通常使用
设备证书、别名证书或证明证书。


# 协议和层次结构

以下部分描述了功能和所需的协议以及
主板平台Active RoT的应用程序编程接口（API）
(PA-RoT) 和主动组件建立平台级 RoT。地狱犬
有源 RoT 和有源组件 RoT 需要支持以下 I2C
协议。

该协议源自 MCTP SMBus/I2C 传输绑定规范。
为不支持的设备定义了协议的有限版本
MCTP。如果 AC-RoT 通过 MCTP 实现证明协议，它也可以
可选地通过本机 SMBus/I2C 实现最小证明协议。


## 认证消息接口

证明消息接口使用 MCTP over I2C 消息协​​议
传输证明有效载荷。AC-RoT MCTP 管理端点
应实施管理组件中详述的所需行为
传输协议 (MCTP) 基本规范，与 MCTP SMBus/I2C 相关
传输绑定规范。以下部分概述了额外的
对管理端点预期行为的要求：

* 消息接口请求和响应消息使用
    自定义消息类型。

* MCTP 消息将在同步请求和响应中传输
    方式而已。端点 (AC-RoT) 永远不应发起请求消息
    到控制器（PA-RoT）。

* MCTP 端点必须严格遵守本协议中定义的响应超时
    规格。当端点收到标准消息时，它应该是
    在 100ms 内发送响应。如果端点还没有开始
    在 100 毫秒内发送响应消息，它应该丢弃消息
    并没有回应。

* MCTP 端点必须严格遵守为广告宣传的响应超时
    加密命令。加密命令包括传输
    消息签名生成和验证。加密命令
    超时倍数是在 Device Capabilities 命令中协商的。

* MCTP 将身份验证留给应用程序实现。这
    规范部分遵循 USB 认证规范的流程
    流程，当身份验证已经建立时，证明种子可以
    交换。

* 不需要管理端点响应 ARP 消息。
    AC-RoT 端点不应生成任何 ARP 消息来通知主机。
    设备应该知道它们通常在 I2C 多路复用器之后，不应该
    在规定的时间之外掌握 I2C 总线
    响应 MCTP 请求消息。

* MCTP 端点设备应仅响应。

* 不管端点是否支持 ARP，它们都应该在
    一种不支持 ARP 的方式。

* MCTP 规范使用大端字节顺序，而本规范
    使用小端字节序。此排序不会更改有效负载
    字节在物理层上发送的顺序。

*端点应支持固定地址；支持端点 ID
    允许单个物理地址后面有多个 MCTP 端点。

* 如 MCTP SMBus/I2C 传输绑定规范端点中所定义
    应该支持快速模式 400KHz。

* 不支持多主机的端点设备应该运行在从机中
    模式。PA-RoT PCD 将识别设备的模式。大师
    将以 MCTP 有效载荷格式发出 SMBUS 写块，然后主机将
    发出 I2C 读取响应。Master 读取最初的 12 个字节
    并使用字节 3 和 MCTP EOM 标头位来确定是否有额外的 SMBUS
    需要读取命令来收集响应消息的其余部分。

* 端点应支持使用 MCTP 设置端点 ID 的 EID 分配
    控制消息。

* 端点应支持 MCTP Get Vendor Defined Message Support 控制
    指示 Cerberus 协议支持级别的消息。

Platform Cerberus Active RoT 始终是 MCTP 主站。活性成分
RoT 可以配置为端点，或端点和主机。活跃的
Component RoT Endpoint 和 Master 应该连接到单独的物理总线。
不需要主仲裁作为主从定义
是分层建立的。活动组件唯一的层次结构
RoT既成为Endpoint又成为Master是当有下游子设备时，
例如以下框图中描述的主机总线适配器 (HBA)：

> 待办事项：图 6

在此图中，HBA RoT 是平台活动 RoT 的端点，并且
掌握下游 HBA 扩展器。对于平台的 Active RoT，HBA
是端点 RoT。对于 HBA 扩展器，HBA 控制器是一个主 RoT。

消息传递协议包含管理组件传输协议
(MCPT) 基本规范，与 MCTP SMBus/I2C 传输绑定相关
规范，活动组件 RoT 是端点，平台的
作为 Master 活跃 RoT。

## 协议格式

所有 MCTP 事务均基于 SMBus 块写入总线协议。这
下表显示了 MCTP 封装的消息；请注意，给出了偏移量
以位为单位，而不是字节。

| 有效载荷 | 说明 |
|------------|------------------------------------ ------|
| 7:0 | I2C 目标地址。|
| 15:8 | 命令代码；必须是“0x0f”。|
| 23:16 | 数据包负载中的字节数。|
| 31:24 | I2C 源地址。|
| 35:32 | 保留（应为零）。|
| 39:36 | MCTP 标头版本。|
| 47:40 | 目的地 EID。|
| 55:48 | 来源 EID。|
| 56:56 | 消息开始 (SOM) 标志。|
| 57:57 | 消息结束 (EOM) 标志。|
| 59:58 | 序列号。|
| 60:60 | 标签所有者。|
| 63:61 | 消息标记。|
| 64+N:64 | 数据包有效载荷。|
| 64+N+8:64+N | 聚醚醚酮 |

一个包应至少包含 1 个字节的有效负载，最多不超过
超过协商的 MCTP 传输单元大小。字节数表示
事务中的后续字节数，不包括 PEC。

每笔交易结束时的 PEC 是使用标准 CRC-8 计算的，
它使用多项式 `x^8 + x^2 + x + 1`，初始值为 0，
和 0 的最终异或。此 CRC 独立于消息完整性检查
由 MCTP 协议定义。CRC 是在整个计算
封装的 MCTP 数据包，其中包括所有标头和目标 I2C
通过 I2C 总线发送的地址（图 7 MCTP 中的字节 1 到 N
封装消息）。由于 I2C 从机地址通常不包含在
交易数据的一部分，CRC 等于 CRC8 (`7_bit_address << 1 ||
i2c_payload`）。例如，发送到具有 7 位 I2C 的设备的 MCTP 数据包
地址“0x41”的 CRC 计算结果为 CRC8（“0x82 || packet”）。


## 数据包格式

物理媒体特定报头和物理媒体特定报尾是
由端口使用的 MCTP 传输绑定规范定义。
请参阅 MCTP 传输绑定规范。

兼容的管理端点应实现所有 MCTP 所需的功能
在 MCTP 基本规范中定义。

基本协议的公共字段包括标识消息类型的字段
MCTP 协议中承载的更高层消息类。


## 传输层报头

管理组件传输协议 (MCTP) 基本规范定义
MCTP包头（字段说明请参考DSP0236）如下。
请注意，偏移量以位为单位，而不是字节。该表对应于
上表中位“31”之后的数据。

| 有效载荷 | 说明 |
|------------|----------------------------|
| 3:0 | 保留（应为零）。|
| 7:4 | MCTP 标头版本。|
| 15:8 | 目的地 EID。|
| 23:16 | 来源 EID。|
| 24:24 | 消息开始 (SOM) 标志。|
| 25:25 | 消息结束 (EOM) 标志。|
| 27:26 | 序列号。|
| 28:28 | 标签所有者。|
| 31:29 | 消息标记。|
| 32:32 | 完整性检查标志。|
| 39:33 | MCTP 消息类型。|
| 变量 | MCTP 标头。|
| 变量 | MCTP 消息数据。|
| 变量 | 完整性检查。|


通常支持空 (`0x00`) 源和目标 EID，但是
具有多个 MCTP 端点的 AC-RoT 设备可以指定一个 EID 值
大于“0x07”且小于“0xff”。PA-RoT 不广播任何
MCTP 消息。

请注意，上面的最后三个字段取决于 MCTP 消息类型。


## MCTP 消息

一条 MCTP 消息由一个或多个 MCTP 数据包组成。通常有两种
消息类型、MCTP 控制消息和 MCTP Cerberus 消息。控制
消息是标准 MCTP 消息，最大消息正文为 64 字节。
Cerberus 消息是本规范中定义的消息。最大讯息
这些消息的正文是 4096 字节，但这个大小可以协商为
更小基于设备的能力。


### 消息类型

根据管理组件传输，消息类型应为“0x7e”
协议 (MCTP) 基本规范。消息类型用于支持Vendor
已定义消息，其中供应商由基于 PCI 的供应商 ID 标识。这
初始消息头在管理组件传输中指定
协议 (MCTP) 基本规范，并在下面详细说明以确保完整性：


    表 2 供应商定义的消息


| 邮件标题 | 字节| 说明 |
|----------------|------|------------------------ ---------------------------------------------- ----------|
| 请求数据 | 1:2 | PCI/PCIe 供应商 ID。根据 0x00 供应商 ID 格式偏移量格式化的 MCTP 供应商 ID。|
| | 3:N | 供应商定义的消息正文。0 到 N 个字节。|
| 响应数据 | 1:2 | PCI/PCIe 供应商 ID，该值按 0x00 供应商 ID 偏移量格式化。|
| | 3:M | 供应商定义的消息正文。0 到 M 字节。|


Vendor ID 是一个 16 位无符号整数，在 PCI 2.3
规格。该值标识设备制造商。

表 4 MCTP 消息格式中描述了消息体和内容。


### 消息字段

MCTP 消息的格式由前两个中的消息头组成
字节，后跟消息数据，并以消息完整性结尾
查看。

消息头包含消息类型 (MT) 字段和完整性检查 (IC)
由 MCTP 基本规范定义。消息类型字段
表明


### 消息完整性检查

消息完整性检查字段包含一个 32 位的 CRC 计算通过
消息的内容。


### 数据包组装成消息

一个 MCTP 消息可以被拆分成多个 MCTP 数据包有效载荷并作为一个
系列数据包。请参阅 MCTP Base Specification 进行打包和
消息组装规则。


### 请求消息

请求消息是由主 MTCP 控制器生成的消息，并且
发送到 MCTP 端点。请求消息指定要执行的操作
端点。请求消息是控制消息或 Cerberus 消息。


### 响应消息

响应消息是当 MCTP 端点
完成对先前发出的请求消息的处理。响应
消息必须在分配的时间内完成或丢弃。


## EID 分配

BMC 会将 EID 分配给不同的 Active Component RoT 设备。全部
主动组件 RoT 设备应支持 MCTP 设置端点 ID 控制
请求和响应消息。Platform Active RoT 的静态 EID 为
0x0b。


# 证书

PA-RoT 和 AC-Rot 将至少有两个证书：设备 ID
证书（通常由离线 CA 签名的 CA）和别名证书
（由设备 ID 证书签名）。PA-RoT 也可能有一个额外的
由设备 ID 证书签名的证明证书。

证书遵循 9.3 DICE 和 RIoT 密钥和证书。


## 格式

所有证书都应使用 X509v3 ASN.1 结构。所有证书应
对 ASN.1 使用二进制 DER 编码。所有证书应符合
RFC5280。为了便于证书链认证，Authority 和 Subject
密钥标识符扩展必须存在。进一步的证书要求是
在 9.3 DICE 和 RIoT 密钥和证书中定义。超出这些的扩展
RFC5280 或 DICE 要求的只要符合
适当的标准。自定义扩展必须标记为非关键。


### 文本格式

证书中包含的所有文本 ASN.1 对象应指定为
`UTF8String`、`PrintableString` 或 `IA5String`。任意长度
文本对象不得超过 64 个字节，不包括 DER 类型和 DER 长度
编码。


### 专有名称

专有名称由许多属性组成，这些属性唯一标识
设备。可分辨名称的唯一性可以通过包括
序列号等属性。


### 对象标识符

对象标识符应遵循 9.3 DICE 和 RIoT 密钥和证书


### 序列号

根据 9.3 DICE 和 RIoT 密钥和证书，证书序列号
每个别名证书在统计上必须是唯一的。

如果安全处理器有一个熵源，一个 8 字节的随机数可以是
用过的。

如果安全处理器没有熵源，则 8 字节
可以使用加密安全密钥推导生成序列号
基于密钥的功能，例如 SP800-108 [9.6 NIST 中描述的那些
特别出版物 800-108]。每个序列号必须是唯一的
生成的证书。对于别名证书，这应该通过
将 FWID 合并到密钥派生过程中（例如作为上下文
SP-800-108 中的值）

如果生成的8字节序列号不是正数，则可能是
填充了一个额外的八位字节以保持与 RFC5280 的一致性。


## 证书链

最大证书链大小为 4096 字节。没有额外的
证书链所需的编码，因为每个证书都可以
单独检索。

证书签名应使用 ECDSA 和 NIST P256 `secp256r1` 曲线
未压缩的点形式。散列应该使用`SHA2-256`进行
算法。


# 验证

身份验证是用于建立对特定设备的信任的过程，并且
证明设备固件的完整性。一旦设备通过身份验证，
可以选择建立安全会话以提供机密性。为了
某些设备，安全会话也可用于启用加密
可用于额外安全性或启用额外的绑定
功能。

设备只需要支持来自另一个端点的单个会话。在
单会话设备，新会话的建立将取代和
终止现有会话以允许新会话。上一届
将在收到会话外（未加密）`GET_DIGESTS` 时终止
请求指定请求的密钥交换。`GET_DIGESTS` 请求收到
会话（加密）或不请求密钥交换不会导致活动
会话终止。


## PA-RoT 和 AC-RoT 认证

使用 Alias 证书链和签名固件对设备进行身份验证
测量。证书链由证书颁发机构认可
签署设备 ID 证书。证书层次结构在
TCG [基于隐式身份的设备认证](https://trustedcomputinggroup.org/wp-content/uploads/TCG-DICE-Arch-Implicit-Identity-Based-Device-Attestation-v1-rev93.pdf)
参考。

证书认证流程紧跟 USB 认证流程
体系结构和身份验证消息。中定义的命令结构
此规范源自 USB-C 身份验证协议。相关的
规范的部分如下：

- 第 3 节：身份验证架构，*USB 身份验证规范*

- 第 4 节：身份验证协议，*USB 身份验证规范*

- 第 5 节：身份验证消息，*USB 身份验证规范*

认证序列从主机（例如 PA-RoT）发出 Get 开始
摘要命令。从站（例如 AC-RoT）以 SHA256 哈希列表响应
对于设备的 Alias 证书链中的每个证书。如果主人有
缓存了证书链，它可以选择跳过请求这些
证书。

如果 master 没有正确的证书，它会发出一个 Get
从服务器的别名证书链中的每个证书的证书请求。
从站将用请求的证书进行响应，该证书必须具有
来自受信任的 CA。

master 将验证 slave 的 Alias 证书链。如果
验证失败或证书已被吊销，认证将
失败。PA-RoT 和 AC-RoT 可以使用吊销补丁进行更新，请参阅
固件更新规范以获取更多详细信息。

一旦证书链被验证，主人将验证
固件完整性通过质询请求。从站将生成一个
使用其别名密钥签名的质询响应，其中包括对
设备固件。主人可以根据组件验证此测量
固件清单 (CFM) 或其他一些确认固件的参考资料
有效的。

认证流程如下：

1. Master 为 Slot 0 发出 `GET_DIGESTS` 命令
2. Slave 响应 Alias 证书链的摘要
3.对于链中的每个证书，Master检查证书是否已被
    缓存。
4.如果证书还没有被缓存，Master发出`GET_CERTIFICATE`
    要求。
5. 从站用请求的证书进行响应。
6. Master 根据受信任的根 CA 验证 Alias 证书链。
7. Master 发出包含 nonce `RN1` 的 Challenge 命令。
8. Slave 生成​​包含的响应
    * 随机数，`RN2`。
    * 集体固件测量，`PMR0`。
    * 使用别名密钥在 (`request || response`) 对上签名。
9. Master验证签名和固件测量

> 待办事项：图 9


## 安全会话建立

Cerberus 设备可选择支持安全会话建立以提供
两个设备之间或外部数据中心软件之间的机密性
装置。会话建立利用基本身份验证流程
额外的密钥交换以建立安全会话。设备
身份验证使用身份证书链，而会话密钥
交换基于临时 ECDH 密钥。设备功能命令将
确定设备是否支持安全会话。

查询设备功能后，主机将开始
通过发出获取摘要请求的身份验证序列。使用时
建立安全会话的身份验证，`GET_DIGESTS` 请求将
还指示最终将使用的密钥交换类型。如果
设备不支持请求的密钥交换，它将以
错误。

身份验证完成后，master 将生成一个临时密钥
并将其发送给奴隶。从站将生成自己的临时会话密钥
并完成密钥交换。会话密钥将通过运行 ECDH 和
包含在会话密钥和随机数上的后续 KDF
挑战。

用于派生会话和 HMAC 密钥的 KDF 是 NIST SP800-108 计数器模式。
会话状态是不稳定的。会话的每一端都必须能够处理一个
会话上下文丢失和支持会话重建。

### 会话建立顺序

会话建立流程从描述的标准身份验证开始
第 5.1.1 节。一旦从站通过身份验证，就使用密钥交换
建立会话。

1. Master 生成一个临时的 ECC 密钥对并发送一个 `Key Exchange`
    包含公钥 (`PKreq`) 的 Type 0 请求。
2. 从站生成一个具有同等强度的临时 ECC 密钥对 (`PKresp`)。
3. Slave 使用 NIST SP800-108 生成 256 位 AES 会话密钥（`K_S`）
    具有以下参数的计数器模式：
    *`K_I = ECDH(PKreq, PKresp)`
    *`标签= RN1`
    *`context = RN2`
    *`r = 32`
4. Slave 使用 NIST SP800-108 生成 256 位 MAC 密钥 (`K_M`)
    具有以下参数的计数器模式（注意 `label` 和 `context` 是
    交换）：
    *`K_I = ECDH(PKreq, PKresp)`
    *`标签= RN2`
    *`上下文= RN1`
    *`r = 32`
5. 从站发送一个密钥交换响应，包括：
    1. 从属会话公钥 (`PKresp`)。
    2. 在“PKreq”和“PKresp”上使用别名密钥的签名。
    3. 使用“K_M”的别名密钥证书的 HMAC。
6. Master 使用公钥生成相同的会话和 MAC 密钥
    密钥交换响应。
7. Master 验证响应中的签名和 HMAC。
8. 现在可以使用共享会话使用 256 位 AES-GCM 加密消息
    钥匙。

> TODO：图 10


## 安全设备绑定

在某些情况下，有必要进行额外级别的身份验证
设备之间。这种额外的身份验证机制用于配对
两个设备，这样任何一个设备的更换都会被检测到。检测
未经授权的部件更换被标记为安全违规。

绑定来自在会话密钥上运行的附加 KDF，以派生
最终会话密钥。参与紧密耦合配对的每个设备都包含
KDF 中用于设备配对会话密钥的公共 HMAC 密钥。这
公共 HMAC 密钥是从两个第一次可用的会话数据中派生的
设备建立安全会话。


### 安全设备绑定序列

具有设备绑定的配对会话从标准安全会话开始。
建立会话后，将使用额外的密钥交换来
更新会话密钥。这个额外的密钥交换必须加密。


1. Master加载配对密钥`K_P`。
    1. 如果这是第一次配对请求，Master 生成密钥使用
        具有以下参数的 NIST SP800-108 计数器模式：
        *`K_I = K_S`
        *`标签=“配对”`
        * 没有`context`
        *`r = 32`
    2.如果Master已经和Slave配对，Master加载密钥
        来自安全存储。
2. Master 使用 NIST SP800-108 计数器模式生成一个新的会话密钥“K_S”。
    *`K_I = K_P`
    *`标签= K_S`
    * 没有`context`
    *`r = 32`
3. Master 发送类型 1 的密钥交换请求，其中包括长度和
    使用“K_M”的配对密钥的 HMAC。此消息使用
    当前会话密钥“K_S”。
4. 从机加载`K_P`
    1. 如果这是此 Master 的第一个配对请求，则 Slave
        使用与 Master 相同的输入生成密钥。
    2.如果Slave已经和Master配对，Slave加载key
        来自安全存储。
5. Slave 计算配对密钥 HMAC 并将其与接收到的数据进行比较。
    * 如果这是这个 Master 的第一个配对请求，Slave 安全地
        存储“K_P”。
7. Slave 生成​​一个新的会话密钥（`K_S'`）。
8. Slave 生成​​一个用“K_S”加密的密钥交换响应。
9. Master 使用“K_S”验证响应。无法使用“K_S”解密
    将要求主机使用“K_S”解密，因为从机不会
    失败时更新会话密钥。
10. 安全会话继续使用“K_S”。加密的消息
    `K_S` 不会被任何一方处理。

> 待办事项：图 11


# 命令格式

以下部分描述了 MCTP 消息格式以支持
身份验证和质询和证明协议。请求/响应
消息正文描述封装在
MCTP 传输。本节不描述 MCTP 传输报头，它
包括 MCTP Header Version、Destination Endpoint ID 等字段
由 MCTP 协议定义。MCTP消息封装描述在
第 3.2 节

MCTP Get Vendor Defined Message Support 命令可以发现什么
支持端点供应商定义的消息。该发现确定了
供应商组织和定义的消息类型。这个请求的格式是
在 MCTP 基本协议规范中描述。

对于 Cerberus 协议，应返回以下信息
响应 MCTP“获取供应商定义的消息支持”请求：

* 供应商 ID 格式：`0x00`
* PCI 供应商 ID：`0x1414`
* 命令集版本：`0x04`


## 证明协议格式

从 PA-RoT 到 AC-RoT 的消息将具有以下格式。
这嵌入在第 3.4 节中定义的结构中。
| 有效载荷 | 说明 |
|------------|------------------------------------ -----|
| 0:0 | 完整性检查标志。|
| 7:1 | MCTP 消息类型（始终为“0x7e”）。|
| 23:8 | MCTP PCI 供应商 ID（始终为“0x1414”）。|
| 24:24 | 请求类型。|
| 25:25 | 保留（应为零）。|
| 26:26 | 如果加密则设置（见下文）。|
| 31:27 | 预订的。|
| 39:32 | Cerberus 命令字节。|
| 变量 | 命令负载。|

协议标头字段仅包含在第一个数据包中
多包 MCTP 消息。重建消息体后，
协议头将用于解释消息内容。保留字段
必须设置为 0。

“请求类型”字段表示请求中包含的请求类型
信息。本规范中定义的消息应将此字段设置为 0。
将此位设置为 1 提供了一种机制，除了不同的供应商 ID 之外，
支持特定于设备的命令集。没有任何附加功能的设备
如果该位为 1，命令支持将返回错误。


## 加密消息

如果在协议头中设置了crypt字段，则消息体包含
加密数据。重建的命令代码字节和完整的消息有效负载
来自单个 MCTP 数据包的数据是加密的。会话建立流程
第 5 节中描述的用于生成加密密钥。一个加密的
消息将具有 16 字节的 GCM 身份验证标记和 12 字节的初始化
消息正文末尾的明文向量。下表显示
加密的 Cerberus 消息的主体，带有加密尾部。笔记
偏移量以位而不是字节为单位给出。

| 有效载荷 | 说明 |
|------------|------------------------------------ ------------------------------|
| 0:0 | 完整性检查标志。|
| 7:1 | MCTP 消息类型（始终为“0x7e”）。|
| 23:8 | MCTP PCI 供应商 ID（始终为“0x1414”）。|
| 24:24 | 请求类型。|
| 25:25 | 保留（应为零）。|
| 26:26 | 如果加密则设置（在这种情况下总是如此）。|
| 31:27 | 预订的。|
| 变量 | 密文；对应于上面的命令字节及其有效负载。|
| N+15:N | AES-GCM 标签。|
| N+31:N+15 | AES-GCM 初始化向量。|

## RoT 命令

下表总结了根据本规范定义的消息，其中
下面的传说：
* "Enc" 表示命令必须在会话中加密。
*“慢”意味着命令执行加密操作，应该使用
    消息超时时间越长。
*“字节”是标识此消息的命令字节。
* "Required" 是消息是否*必须*实现：`R` 表示
    “在所有情况下都需要”；`O` 表示“必要时执行”；`M` 表示
    “需要认证大师”。

| 留言名称 | 编码 | 慢 | 字节| 必填 | 说明 |
|----------------------------|-----|------|------| ----------|------------------------------------ --------------|
| `错误` | | | 0x7f | 右 | 默认响应消息。|
| `固件版本` | | | 0x01 | 右 | 检索固件版本信息。|
| `设备能力` | | | 0x02 | 右 | 检索设备功能。|
| `设备ID` | | | 0x03 | 右 | 检索设备 ID。|
| `设备信息` | | | 0x04 | 右 | 检索设备信息。|
| `出口企业社会责任` | | | 0x20 | 右 | 导出设备密钥的 CSR。|
| `导入证书` | | × | 0x21 | 右 | 导入 CA 签名证书。|
| `获取证书状态` | | | 0x22 | 右 | 检查已签名证书链的状态。|
| `获取摘要` | | × | 0x81 | 右 | 检索证书链摘要。|
| `获得证书` | | | 0x82 | 右 | 检索证书链。|
| `挑战` | | × | 0x83 | 右 | 验证集体测量。|
| `密钥交换` | | × | 0x84 | 欧 | 交换会话密钥和制造设备配对密钥。|
| `会话同步` | × | × | 0x85 | 欧 | 检查安全会话的状态。|
| `获取日志信息` | | | 0x4f | 欧 | 检索日志信息。|
| `获取日志` | | | 0x50 | 欧 | 检索调试、证明和篡改日志。|
| `清除日志` | | | 0x51 | 欧 | 清除设备日志。|
| `获取证明数据` | | | 0x52 | 欧 | 从证明日志中检索原始数据。|
| `获取主机状态` | | | 0x40 | 欧 | 获取主机处理器的复位状态。|
| `获取PFM Id` | | | 0x59 | 欧 | 获取 PFM 信息。|
| `获得 PFM 支持` | | | 0x5a | 欧 | 检索 PFM。|
| `准备 PFM` | | | 0x5b | 欧 | 准备传入的 PFM 更新。|
| `更新PFM` | | | 0x5c | 欧 | 上传新 PFM 的一部分。|
| `激活PFM` | | | 0x5d | 欧 | 激活新上演的 PFM。|
| `获取CFM Id` | | | 0x5e | 男| 获取 CFM 信息。|
| `准备 CFM` | | | 0x5f | 男| 准备传入的 CFM 更新。|
| `更新CFM` | | | 0x60 | 男| 上传新 CFM 的一部分。|
| `激活 CFM` | | | 0x61 | 男| 激活新上演的 CFM。|
| `获得 CFM 支持` | | | 0x8d | 男| 检索支持的 CFM ID。|
| `获取PCD ID` | | | 0x62 | 男| 获取 PCD 信息。|
| `准备 PCD` | | | 0x63 | 男| 准备传入的 PCD 更新。|
| `更新PCD` | | | 0x64 | 男| 上传新 PCD 的一部分。|
| `激活PCD` | | | 0x65 | 男| 激活新阶段的 PCD。|
| `准备固件更新` | | | 0x66 | 欧 | 准备传入的固件更新。|
| `更新固件` | | | 0x67 | 欧 | 上传新固件图像的一部分。|
| `更新状态` | | | 0x68 | 男| 固件或清单更新状态 |
| `扩展更新状态` | | | 0x8e | 男| 固件或清单扩展状态 |
| `激活固件更新` | | | 0x69 | 欧 | 激活新阶段的固件更新。|
| `重置配置` | | × | 0x6a | 欧 | 将配置重置为默认状态。|
| `获取配置 ID` | | × | 0x70 | 男| 获取经过身份验证的清单 ID。|
| `恢复固件` | | | 0x71 | 欧 | 使用备份恢复固件索引。|
| `准备恢复映像` | | | 0x72 | 欧 | 准备传入的恢复映像更新。|
| `更新恢复图像` | | | 0x73 | 欧 | 上传新恢复映像的一部分。|
| `激活恢复映像` | | | 0x74 | 欧 | 激活新上演的恢复映像。|
| `获取恢复映像 ID` | | | 0x75 | 欧 | 获取恢复映像信息。|
| `获取PMR` | | × | 0x80 | 欧 | 获取平台测量寄存器。|
| `更新PMR` | × | × | 0x86 | 欧 | 扩展平台测量寄存器。|
| `重置计数器` | | | 0x87 | 右 | 重置计数器。|
| `开封消息` | | × | 0x89 | 欧 | 开始开封挑战。|
| `解封消息结果` | | | 0x8a | 欧 | 获取解封状态和结果。|

命令字节“0xf0”到“0xff”永远不会被 Cerberus 分配，并且可能
被视为“私人使用”区域。

关于所需消息的注释：
1. 如果支持任何“Enc”消息，则需要 `Key Exchange` 和 `Session Sync`。
2. 如果支持证明日志，则需要“获取证明数据”。
3. 如果有任何更新命令（例如，`Prepare`/`Update`/`Activate` 命令）
   支持，需要`Update Status`和`Extended Update Status`。
4. 如果支持任何清单类型，则需要“获取配置 ID”。


## 消息体结构

以下部分描述了 MCTP 消息体的结构。


### 错误信息

当命令不是时，命令响应返回错误命令
按建议完成，它还充当命令的通用状态
响应，其中“无错误”代码将指示成功。消息标签，
Sequence Number 和 Command 匹配对应请求的响应。
Message Body 返回如下：

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 错误代码 |
| 2:5 | 错误数据 |

“错误代码”是以下之一：


    表 9 错误代码


| 错误代码 | 价值 | 说明 | 资料 |
|------------------------|--------|---------------- --------------------------|----------------|
| 没有错误 | 0x00 | 成功 | 0x00 |
| 无效请求 | 0x01 | 请求中的无效数据 | 0x00 |
| 忙 | 0x03 | 设备正忙于处理其他命令 | 0x00 |
| 未指定 | 0x04 | 发生未指定的错误 | 供应商定义 |
| 无效校验和 | 0xf0 | 无效校验和 | 校验和 |
| 故障消息 | 0xf1 | EOM 先于 SOM | 0x00 |
| 认证 | 0xf2 | 身份验证未建立 | 0x00 |
| 乱序窗口 | 0xf3 | 从序列窗口接收到的消息 | 0x00 |
| 无效数据包长度 | 0xf4 | 收到的数据包大小意外 | 数据包长度 |
| 消息溢出 | 0xf5 | 消息超过最大长度 | 消息长度 |

如果未为命令定义中的命令定义定义显式响应
在接下来的部分中，错误消息是带有“无错误”的预期响应。
错误消息可以作为任何失败命令的响应出现
加工。

### 固件版本

此命令获取目标固件的版本。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 面积指数 |

面积指标如下：
* 0x00：整个固件
* 0x01: 防暴核心
* 附加索引由供应商定义。

#### 回应

| 有效载荷 | 说明 |
|--------|--------------------------------|
| 1:32 | 固件版本号 (ASCII) |


### 设备能力

设备功能提供有关设备功能的信息。讯息
和数据包最大值是根据共享功能协商的。一些
在确定适当的最大尺寸时，还需要考虑其他因素：


1.根据MCTP规范，数据包有效负载大小必须不小于64
    字节。

2. 根据第 3.5 节，消息负载大小不得超过 4096 字节。

3.设备支持的总数据包大小将包括封装
    在 3.2 节中定义，不包括目标地址的第一个字节。
    例如，最大数据包有效负载为 247 字节将导致 256 字节
    为每个数据包传输：
    * 1 字节目的地址。
    * 3 字节 SMBus 标头。
    * 4 字节 MCTP 标头。
    * 247 字节有效负载。
    * 1 字节 CRC-8。

4. 部分命令不支持跨消息分隔。设备必须
    支持与预期有效负载兼容的最大消息大小
    对于支持的命令。

5. 主设备，如 PA-RoT，应支持最大消息大小
    4096 字节以确保与任何从属设备完全兼容。

<!-- TODO：将这些转换为适当的降价表。就这样，有点过分
    机械地做起来很复杂。-->


#### 要求

<表>
    <tr>
        <td> <strong>负载</strong> </td>
        <td><strong>描述</strong> </td>
    </tr>
    <tr>
        <td>1:2</td>
        <td>最大消息负载大小</td>
    </tr>
    <tr>
        <td>3:4</td>
        <td>最大数据包负载大小</td>
    </tr>
    <tr>
        <td>5</td>
        <td>模式：
            <br> [7:6]
            <br> 00 = AC-RoT
            <br> 01 = PA-RoT
            <br> 10 = 外部
            <br> 11 = 保留
            <br> [5:4] 主/从
            <br> 00 = 未知
            <br> 01 = 大师
            <br> 10 = 奴隶
            <br> 11 = 主从
            <br> [3] 预留
            <br> [2:0] 安全
            <br> 000 = 无
            <br> 001 = 哈希/KDF
            <br> 010 = 身份验证 [证书授权]
            <br> 100 = 机密性 [AES] </td>
    </tr>
    <tr>
        <td>6</td>
        <td>[7] PFM 支持
            <br> [6] 政策支持
            <br> [5] 固件保护
            <br> [4-0]保留</td>
    </tr>
    <tr>
        <td>7</td>
        <td>PK 关键力量：
            <br> [7] RSA
            <br> [6] ECDSA
            <br> [5:3] 纠错码
            <br> 000：无
            <br> 001: 160 位
            <br> 010: 256 位
            <br> 100：保留
            <br> [2:0] RSA：
            <br> 000：无
            <br>001：RSA 2048
            <br>010：RSA 3072
            <br>100：RSA 4096</td>
    </tr>
    <tr>
        <td>8</td>
        <td>加密密钥强度：
            <br> [7] 纠错码
            <br> [6:3] 保留
            <br> [2:0] AES：
            <br> 000：无
            <br> 001: 128 位
            <br> 010: 256 位
            <br>100: 384 位</td>
    </tr>
</表>


#### 回复

<表>
    <tr>
        <td><strong>负载</strong> </td>
        <td><strong>描述</strong> </td>
    </tr>
    <tr>
        <td>1:2</td>
        <td>最大消息负载大小</td>
    </tr>
    <tr>
        <td>3:4</td>
        <td>最大数据包负载大小</td>
    </tr>
    <tr>
        <td>5</td>
        <td>模式：
            <br> [7:6]
            <br> 00 = AC-RoT
            <br> 01 = PA-RoT
            <br> 10 = 外部
            <br> 11 = 保留
            <br> [5:4] 主/从
            <br> 00 = 未知
            <br> 01 = 大师
            <br> 10 = 奴隶
            <br> 11 = 主从
            <br> [3] 预留
            <br> [2:0] 安全
            <br> 000 = 无
            <br> 001 = 哈希/KDF
            <br> 010 = 身份验证 [证书授权]
            <br> 100 = 机密性 [AES] </td>
    </tr>
    <tr>
        <td>6</td>
        <td>[7] PFM 支持
            <br> [6] 政策支持
            <br> [5] 固件保护
            <br> [4-0]保留</td>
    </tr>
    <tr>
        <td>7</td>
        <td>PK 关键力量：
            <br> [7] RSA
            <br> [6] ECDSA
            <br> [5:3] 纠错码
            <br> 000：无
            <br> 001: 160 位
            <br> 010: 256 位
            <br> 100：保留
            <br> [2:0] RSA：
            <br> 000：无
            <br>001：RSA 2048
            <br>010：RSA 3072
            <br>100：RSA 4096</td>
    </tr>
    <tr>
        <td>8</td>
        <td>加密密钥强度：
            <br> [7] 纠错码
            <br> [6:3] 保留
            <br> [2:0] AES：
            <br> 000：无
            <br> 001: 128 位
            <br> 010: 256 位
            <br>100: 384 位</td>
    </tr>
    <tr>
        <td>9</td>
        <td>最大消息超时：10 毫秒的倍数</td>
    </tr>
    <tr>
        <td>10</td>
        <td>最大加密消息超时：100 毫秒的倍数</td>
    </tr>
</表>


### 设备ID

八字节响应。

#### 要求

空的身体。

### 回复

| 有效载荷 | 说明 |
|--------|--------------------------|
| 1:2 | 供应商编号；最低位|
| 3:4 | 设备ID; 最低位|
| 5:6 | 子系统供应商 ID；最低位|
| 7:8 | 子系统 ID；最低位|


### 设备信息

此命令获取有关目标设备的信息。

#### 要求

| 有效载荷 | 说明 |
|--------|--------------------|
| 1 | 信息索引 |


信息指标如下：
* 0x00：唯一芯片标识符。
* 附加索引由供应商定义。

#### 回复

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1:N | 请求的标识符 blob |


### 导出 CSR

导出设备标识证书自签名证书签名
要求。初始证书是自签名的，直到 CA 签名并导入。
将 CA 签名版本的证书导入到设备后，
自签名证书被替换。

#### 要求

| 有效载荷 | 说明 |
|--------|--------------------|
| 1 | 索引：默认 = 0 |

#### 回复

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1:N | 证书签名请求 |


###导入证书

将签名的设备 ID 证书链导入设备。
每个导入命令将链中的单个证书发送到设备，并且
这些证书的顺序没有要求
进口。在验证完整链后，设备被密封，并且没有
可以在不更改固件的情况下进行进一步的导入。响应消息是
在使用新证书执行证书链验证之前返回
证书，仅指示证书是否被设备接受。
可以使用 Get 查询证书配置的完整状态
证书状态请求。

收到证书后，设备将开始验证存储的
证书链。发送多个证书时，可能需要
在发送新的之前确保之前的身份验证步骤已经完成
证书。可以使用获取证书检查身份验证状态
国家指挥。

#### 要求

| 有效载荷 | 说明 |
|--------|--------------------|
| 1 | 类型 |
| 2:3 | 证书长度 |
| 4:N | 证书 |


证书类型如下：
* 0x00: 设备 ID 证书
* 0x01: 根 CA 证书
* 0x02: 中级 CA 证书


### 获取证书状态

确定已签名证书的证书链状态
被发送到设备。此命令的请求不包含额外的
有效载荷。

#### 要求

空的身体。

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ ----------|
| 1 | 状态 |
| 2:4 | 错误详细信息，如果链验证失败。|

可能的状态：
* 0x00：已提供有效链。
* 0x01：尚未提供有效链。
* 0x02：正在验证存储链。

### 获取摘要

此命令源自类似的 USB Type C-Authentication Message。这
不包括协议版本字节，消息类型存在于
MCTP 消息的命令字节。请参阅：表 4 MCTP 消息格式。这
响应不同，因为证书处理不同于 USB Type C，并且
保留字节被重新利用。

可以随时发送此命令。如果之前进行身份验证
已建立，此命令将重新协商/覆盖以前的身份验证
和会话建立。字节 2，保留 USB Type C – 认证
规范，用于描述密钥交换算法。这是相关的
当请求者和响应者支持多种密钥交换算法时。

不包含有效证书链的插槽将生成响应
有 0 个摘要。有效载荷字节 2 将指示没有返回任何摘要。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ ----------------------|
| 1 | 要读取的目标证书链的槽号（0 到 7）。|
| 2 | 密钥交换算法 |

潜在的密钥交换算法是：
* 0x00：无
* 0x01：ECDH

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ ----------------------------------|
| 1 | 功能字段（始终为 0x01）。|
| 2 | 返回的摘要数。|
| 3:N | 链中证书的 SHA256 摘要，从根开始。|


### 获取证书

此命令检索 AC-RoT 的公共证明证书链。
它严格遵循 USB C 型身份验证规范。

如果设备没有请求的插槽或索引的证书，则
响应中的证书内容将为空。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------------------|
| 1 | 要读取的目标证书链的槽号（0 到 7）。|
| 2 | 要读取的证书，从根证书开始进行零索引。|
| 3:4 | 偏移量：从要读取的证书开始的偏移量（以字节为单位）。|
| 5:6 | 长度：要读取的字节数。|

#### 回应

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------|
| 1 | 返回的目标证书链的槽号。|
| 2 | 返回证书的证书索引 |
| 3:N | 目标证书链的请求内容。|


### 挑战

PA-RoT 将发送此命令，提供密钥交换中的第一个随机数。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ ----------------------|
| 1 | 要读取的目标证书链的槽号（0 到 7）。|
| 2 | 保留 |
| 3:35 | 随机数 |

#### 回应

| 有效载荷 | 说明 |
|--------|------------------------------------ ------------------------------|
| 1 | 使用的证书链的槽号。|
| 2 | 证书插槽掩码 |
| 3 | 设备支持的 MinProtocolVersion |
| 4 | 设备支持的 MaxProtocolVersion |
| 5:6 | 保留 |
| 7:38 | 随机数 |
| 39 | 用于生成 PMR0 测量的组件数量 |
| 40 | PMR0 的长度 (L) |
| 41:40+左 | PMR0（聚合固件摘要）的值 |
| 41+左：中 | 在连接的请求和响应消息有效负载上签名。|

固件摘要是安全描述符和
目标组件的固件。此固件测量数据不
包括 Cerberus PCD、CFM 或​​ PFM。这些测量值在 PMR1 中返回。这
编号在 6.44 获取配置 ID 中检索。USB-C 上下文哈希
不包括在挑战中。这被上下文测量所取代
对于设备。注意：证明证书派生将包括
固件和安全描述符的测量。PMR0预计是
变化最小的 PMR，因为它包含安全描述符的度量
和设备初始引导加载程序。


### 密钥交换

密钥交换用于与设备建立加密通道。这
会话建立流程在第 5 节身份验证中有详细说明。

收到密钥类型为 0 的消息后，双方可以建立一个
加密会话。如果密钥类型 1，配对的密钥也进行比较，并配对
如果验证与预期的密钥匹配，则功能被解锁。关键类型
1 只能在加密会话下执行，因为会话密钥是
HMAC 需要。最初计算配对密钥时 (K<sub​​>P</sub>)
对于设备绑定，会话的 Key Type 0 请求中指定的 HMAC
将与 KDF 一起使用。

关闭已建立的会话（Key Type 2）时，响应将是
如果会话成功终止，则以纯文本形式传输。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------|
| 1 | 键类型 |
| 2:N | 关键数据。格式由请求类型定义。|

可能的密钥类型：
* 0x00：会话密钥。
* 0x01：配对密钥 HMAC。
* 0x02: 销毁会话。

##### 会话密钥数据

| 有效载荷 | 说明 |
|--------|------------------------------------ ------|
| 1 | HMAC 算法 |
| 2:N | ASN.1 DER 编码的 ECC 公钥 (`PKreq`) |

可能的 HMAC 哈希算法：
* 0x00：SHA-256
* 0x01: SHA-384
* 0x02：SHA-512

此消息中指定的 HMAC 类型适用于所有 HMAC 操作
已建立的会话，包括任何后续配对消息。自会议以来
密钥（`K_S` 和 `K_M`）是 256 位密钥，它们将始终使用
SHA-256 无论用于密钥交换消息的 HMAC 类型如何。

##### 配对密钥 HMAC 数据

| 有效载荷 | 说明 |
|--------|------------------------------------ -----|
| 1:2 | 配对密钥的字节长度 |
| 3:N | 配对密钥的 HMAC：`HMAC(K_M, K_P)` |

##### 销毁会话数据

| 有效载荷 | 说明 |
|--------|------------------------------------ |
| 1:N | 会话密钥的 HMAC：`HMAC(K_M, K_S)` |

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ ------------------|
| 1 | 请求的密钥类型 |
| 2:N | 响应数据。格式由请求类型定义。|

##### 会话密钥数据

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------|
| 1 | 预订的。设置为 0。
| 2:3 | 密钥长度 |
| 4:N | DER 编码的 ECC 公钥 (`PKresp`) |
| N+1:N+2 | 签名长度 |
| N+3:M | 通过会话密钥签名：`SIGN(PKreq || PKresp)` |
| M+1:M+2 | HMAC 长度 |
| M+3:H | 别名证书的 HMAC：`HMAC(KM, alias_cert)` |

##### 配对密钥 HMAC 数据

空的身体。

##### 销毁会话数据

空的身体。


### 会话同步

检查加密会话的状态。
消息必须始终加密。

#### 要求。

| 有效载荷 | 说明 |
|--------|------------------------|
| 1:4 | 随机数 (`RNreq`) |

#### 回复。

| 有效载荷 | 说明 |
|--------|------------------------------------ |
| 1:N | nonce 的 HMAC：`HMAC(KM, RNreq)` |


### 获取日志信息

获取 RoT 的内部日志信息。

#### 要求

空的身体。

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ -|
| 1:4 | 调试日志 (0x01) 字节长度 |
| 5:8 | 证明日志 (0x02) 字节长度 |
| 9:12 | 篡改日志 (0x03) 字节长度 |


### 获取日志

获取 RoT 的内部日志。有 3 种类型的日志可用：
调试日志，其中包含 Cerberus 应用程序信息和机器状态。
Attestation measurement log，这种日志格式类似于TCG日志，而
篡改日志。无法清除或重置篡改计数器。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 日志类型 |
| 2:5 | 抵消 |

可能的日志类型：
* 0x01：调试日志。
* 0x02: 证明日志。
* 0x03：篡改日志。

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------|
| 1:N | 日志的内容。|


长度由日志末尾决定，或数据包大小基于设备能力见
部分：6.7 设备功能。如果响应跨越多个 MCTP 消息，结束
响应将由有效负载小于的 MCTP 消息确定
两个设备支持的最大有效负载。保证永远不会有回应
恰好落在最大负载边界上，响应者必须发回一个额外的
零负载的数据包。

#### 鉴证日志格式

证明日志将报告所有组件的单独测量
每个PMR。每个测量将是日志中的一个条目。整个日志
由按顺序连接的每个条目组成。条目的结构
非常类似于 TCG 事件。请参阅 TCG PC 客户端平台固件配置文件
规格。

日志条目标题：

| 抵消 | 说明 |
|--------|---------------------------------------- ----------------------------------------------|
| 1 | 日志条目开始标记：[7:4]: 0x0c [3:0]：标头格式，根据此规范为 0x0b。|
| 2:3 | 条目的总长度，包括标题 |
| 4:7 | 唯一条目标识符 |

证明条目格式：

| 抵消 | 说明 |
|--------|---------------------------------------- ------|
| 1:7 | 日志条目标题 |
| 8:11 | TCG 事件类型 |
| 12 | 单个PMR内的测量指标。|
| 13 | 用于测量的 PMR 的索引。|
| 14:15 | 保留，设置为 0。
| 16 | 摘要数 |
| 17:19 | 保留，设置为 0。
| 20:21 | 摘要算法 Id (`0x0b`, SHA-256) |
| 22:53 | SHA-256 摘要用于扩展测量。|
| 54:57 | 测量长度 |
| 58:89 | 测量 |

#### 调试日志格式

设备报告的调试日志没有指定格式，因为这可能会有所不同
在不同的设备之间，不需要证明。这是
预计该设备的诊断实用程序将能够理解
暴露的日志信息。此处提供了推荐的条目格式。

建议的调试条目格式：

| 抵消 | 说明 |
|--------|--------------------------------|
| 1:7 | 日志条目标题 |
| 8:9 | 条目的格式版本。|
| 10 | 条目的严重性。|
| 11 | 消息源的 ID。|
| 12 | 条目消息类型的 ID。|
| 13:16 | 消息特定参数。|
| 17:20 | 消息特定参数。|

### 清除调试/证明日志

清除 RoT 中的日志。请注意，无法清除篡改日志。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 日志类型 |


注意：在清除证明日志时，它会自动重新创建使用
电流测量。


### 获取鉴权数据

获取用于生成证明日志中报告的测量的原始数据。
并非所有测量都有可用的原始数据，因为这主要是为了
用于对少量数据或文本生成的测量。要求
不提供测量数据的条目将生成正常响应
负载为空。对无效条目的请求将产生错误
回复。

虽然此命令旨在支持应该
适合单个 MCTP 消息，请求中包含偏移量参数
以支持所需数据过大的场景。

#### 要求

| 有效载荷 | 说明 |
|--------|--------------------------------|
| 1 | 平台测量寄存器 |
| 2 | 入门索引 |
| 3:6 | 抵消 |

#### 回复

| 有效载荷 | 说明 |
|--------|--------------------|
| 1:N | 实测数据。|


### 获取主机状态

检索受 Cerberus 保护的主机处理器的重置状态。


#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 端口编号 |

#### 回复
| 有效载荷 | 说明 |
|--------|------------------|
| 1 | 主机重置状态 |

可能的状态：
* 0x00 - 主机正在运行。
* 0x01 - 主机处于复位状态。
* 0x02 - 主机未运行，也未处于重置状态。

### 获取PFM ID

检索 PFM 标识符。

#### 要求

| 有效载荷 | 说明 |
|------------|-------------------------------- --------------------------|
| 1 | 端口编号 |
| 2 | PFM 区域：0x00 = 活动，0x01 = 待定 |
| 3（可选） | 标识符：0x00 = 版本 ID（默认），0x01 = 平台 ID |

#### 回复

| 有效载荷 | 说明 |
|--------|--------------------------|
| 1 | PFM 有效（0x00 或 0x01）|
| 2:5 | PFM 版本 ID |

| 有效载荷 | 说明 |
|--------|------------------------------------ ---|
| 1 | PFM 有效（0 或 1）|
| 2:N | PFM 平台 Id 作为空终止 ASCII |


### 获取 PFM 支持的固件

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ -----|
| 1 | 端口编号 |
| 2 | PFM 区域：0x00 = 活动，0x01 = 待定 |
| 3:6 | 抵消 |

#### 回复

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1 | PFM 有效（0x00 或 0x01）|
| 2:5 | PFM 版本 ID |
| 6:N | PFM 支持的固件版本 |

如果响应跨越多个 MCTP 消息，则响应结束将由
一个 MCTP 数据包，其有效载荷小于两者支持的最大有效载荷
设备。保证响应永远不会恰好落在最大负载上
边界，响应者应该发回一个零负载的额外数据包。


###准备PFM

为传入的 PFM 提供 RoT。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 端口编号 |
| 2:5 | 总尺寸 |

####更新PFM

闪存描述符结构描述了设备的闪存区域。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 端口编号 |
| 2:N | PFM 有效载荷 |

PFM 有效载荷包括 PFM 签名和单调仅前向 Id。PFM签名
在收到所有 PFM 有效载荷后进行验证。PFM 被激活
激活命令。请注意，如果系统在收到 PFM 后重新启动，则
PFM 是原子激活的。要在重新启动前激活，请发出 Activate PFM
命令。


## 激活 PFM

在有效的 PFM 更新后，更新命令密封 PFM 提交方法。如果
立即提交，此时应暂停闪存读写
发出命令。RoT 将控制 SPI 总线并验证新更新的
PFM。此命令只能遵循有效的 PFM 更新。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------|
| 1 | 端口编号 |
| 2 | 激活：0x00 = 仅重启，0x01 = 立即 |

如果仅发出重启，则“立即”提交 PFM 的选项
在更新新的 PFM 之前不可用。


### 获取 CFM ID

检索组件固件清单 ID

#### 要求

| 有效载荷 | 说明 |
|------------|-------------------------------- --------------------------|
| 1 | 端口编号 |
| 2 | CFM 区域：0x00 = 活动，0x01 = 待定 |
| 3（可选） | 标识符：0x00 = 版本 ID（默认），0x01 = 平台 ID |

#### 回复

| 有效载荷 | 说明 |
|--------|--------------------------|
| 1 | CFM 有效（0x00 或 0x01）|
| 2:5 | CFM 版本 ID |

| 有效载荷 | 说明 |
|--------|------------------------------------ ---|
| 1 | CFM 有效（0 或 1）|
| 2:N | CFM 平台 ID 为空终止 ASCII |


###准备CFM

为传入的组件固件清单提供 RoT。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1:5 | 总尺寸 |


###更新CFM

闪存描述符结构描述了设备的闪存区域。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1:N | CFM 有效载荷 |

CFM 有效载荷包括 CFM 签名和单调仅前向 Id。循环流量计
在收到所有 CFM 有效负载后验证签名。CFM 被激活
根据激活命令。请注意，如果系统在收到
CFM，待处理的 CFM 已验证并自动激活。激活前
重新启动，发出 Activate CFM 命令。


### 激活CFM

在有效的 CFM 更新后，更新命令密封 CFM 提交方法。这
RoT 将掌握 I2C 并验证平台配置数据中的组件
反对CFM。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------|
| 1 | 激活：0x00 = 仅重启，0x01 = 立即 |


### 获取 CFM 组件 ID

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ ------|
| 1 | CFM 区域：0x00 = 活动，0x01 = 待定 |
| 2:5 | 抵消 |


#### 回复

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1 | CFM 有效（0x00 或 0x01）|
| 2:5 | CFM 版本 ID |
| 6:N | CFM 支持的组件 ID |

如果响应跨越多个 MCTP 消息，则响应结束将由
一个 MCTP 数据包，其有效载荷小于两者支持的最大有效载荷
设备。保证响应永远不会恰好落在最大负载上
边界，响应者应该发回一个零负载的额外数据包。


### 获取PCD ID

检索 PCD Id。

#### 要求

| 有效载荷 | 说明 |
|------------|-------------------------------- --------------------------|
| 1（可选） | 标识符：0x00 = 版本 ID（默认），0x01 = 平台 ID |

#### 回复

| 有效载荷 | 说明 |
|--------|--------------------------|
| 1 | PCD 有效（0x00 或 0x01）|
| 2:5 | PCD 版本 ID |

| 有效载荷 | 说明 |
|--------|------------------------------------ ---|
| 1 | PCD 有效（0x00 或 0x01）|
| 2:N | PCD 平台 ID 为空终止 ASCII |


###准备PCD

为传入的平台配置数据提供 RoT。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1:4 | 总尺寸 |


###更新PCD

闪存描述符结构描述了设备的闪存区域。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1:N | PCD 有效载荷 |


PCD 有效载荷包括 PCD 签名和单调仅前向 Id。PCD
在收到所有 PCD 有效载荷后验证签名。PCD 被激活
激活命令。请注意系统是否在收到 PCD 后重新启动。


###激活PCD

在有效的 PCD 更新后，激活命令会密封 PCD 承诺。

#### 要求

空的身体。


### 平台配置

下表描述了平台配置数据结构。

<!-- TODO: 将其转换为合适的表格 -->
<表>
    <tr>
        <td><strong>负载</strong> </td>
        <td><strong>描述</strong> </td>
    </tr>
    <tr>
        <td>1:3</td>
        <td>平台配置数据Id</td>
    </tr>
    <tr>
        <td>4:5</td>
        <td>长度</td>
    </tr>
    <tr>
        <td>6</td>
        <td>策略计数</td>
    </tr>
    <tr>
        <td>7:N</td>
        <td>每个 AC-RoT 都有 1 个条目。
            配置数据决定了功能
            启用和证明
            <br>
            <表>
                <tr>
                    <td>字节</td>
                    <td>描述</td>
                </tr>
                <tr>
                    <td>1</td>
                    <td>设备编号</td>
                </tr>
                <tr>
                    <td>4</td>
                    <td>频道</td>
                </tr>
                <tr>
                    <td>5</td>
                    <td>从站地址</td>
                </tr>
                <tr>
                    <td>6</td>
                    <td>[7:5] 阈值计数
                        <br> [4] 电源控制
                        <br> 0 = 禁用
                        <br> 1 = 启用
                        <br> [3] 启用调试
                        <br> 0 = 禁用
                        <br> 1 = 启用
                        <br> [2] 自动恢复
                        <br> 0 = 禁用
                        <br> 1 = 启用
                        <br> [1] 政策有效
                        <br> 0 = 禁用
                        <br> 1 = 启用
                        <br> [0] 阈值有效
                        <br> 0 = 禁用
                        <br> 1 = 启用</td>
                </tr>
                <tr>
                    <td>7</td>
                    <td>电源控制索引</td>
                </tr>
                <tr>
                    <td>8</td>
                    <td>失败操作</td>
                </tr>
            </表>
        </td>
    </tr>
    <tr>
        <td>N:N</td>
        <td>有效载荷签名</td>
    </tr>
</表>

功率控制索引通知 PA-RoT 分配给功率的索引
对组件进行排序。这通知 PA-RoT 哪个控制寄存器需要
在平台电源定序器中断言。

可能的故障操作：
* 0x00：平台定义。
* 0x01：仅报告。
* 0x02: 自动恢复。
* 0x03：电源控制。


### 准备固件更新

为传入的固件更新提供 RoT。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1:4 | 总尺寸 |


### 更新固件

闪存描述符结构描述了设备的闪存区域。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ ------|
| 1:N | 固件更新有效负载、标头签名。|


### 更新状态

更新状态报告更新负载状态。更新状态将是
请求的最后一个操作的状态。该状态将保持
相同，直到执行另一个操作或 Cerberus 被重置。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 更新类型 |
| 2 | 端口编号 |

可能的更新类型：
* 0x00：固件
* 0x01：PFM
* 0x02：CFM
* 0x03：PCD
* 0x04：主机固件
* 0x05：恢复固件
* 0x06：重置配置

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------------------|
| 1:4 | 更新状态。有关详细信息，请参阅固件更新规范。|


### 扩展更新状态

扩展更新状态报告更新负载状态以及
预期的剩余更新字节数。更新状态将为
请求的最后一个操作。此状态将保持不变，直到
执行了另一个操作或 Cerberus 被重置。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 更新类型 |
| 2 | 端口编号 |

可能的更新类型：
* 0x00：固件
* 0x01：PFM
* 0x02：CFM
* 0x03：PCD
* 0x04：主机固件
* 0x05：恢复固件
* 0x06：重置配置

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------------------|
| 1:4 | 更新状态。有关详细信息，请参阅固件更新规范。|
| 5:8 | 剩余的预期更新字节。|


### 激活固件更新

提醒 Cerberus 更新字节的发送已完成，并且验证
更新应该开始。此命令没有负载，ERROR 响应为零
预期的。

#### 要求

空的身体。


### 重置配置

将配置参数重置为默认状态。取决于
请求参数，可以擦除不同数量类型的配置，
并且每种类型的配置可能需要不同级别的授权才能
完全的。

如果操作需要授权才能完成，响应将
包含必须签名的特定于设备的一次性使用授权令牌
用 PFM 键解锁操作。授权令牌具有
以下行为：

1. 请求相同操作但未提供签名授权
    token 将生成一个使任何旧令牌无效的新令牌。这是
    即使旧令牌尚未使用，也是如此。

2. 使用授权令牌解锁操作后，可以
    永远不会再被使用。必须请求新令牌。这是真的，即使
    请求的操作无法成功完成。

3. 提供签名令牌时未能授权请求不
    使设备中的当前授权令牌无效。

如果不需要授权，或者请求是使用签名令牌发送的，则
将返回标准错误响应以指示状态。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ ------------------------------|
| 1 | 要请求的重置操作类型。|
| 2:N | （可选）特定于设备的授权令牌，使用 PFM 密钥签名。|

可能的重置类型：
* 0x00：通过擦除所有内容将设备恢复到不受保护（旁路）状态
    PFM 和 CFM。
* 0x01：通过删除所有配置执行出厂重置。这不
    包括签名的设备证书。

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------|
| 1:N | 特定于设备的授权令牌 |


### 获取配置 ID

此命令检索 PFM Id、CFM Id、PCD Id 和请求的签名摘要
随机数和响应 ID。

#### 要求

| 有效载荷 | 说明 |
|--------|----------------|
| 1:32 | 随机数 |

#### 回复

| 有效载荷 | 说明 |
|------------------------|-------------------- ------|
| 1:32 | 随机数 |
| 33 | PFM ID 数 (P) |
| 34 | CFM ID 数 (C) |
| 35:(P*4 + C*4 + 4) (V') | PFM、CFM、PCD 版本 ID |
| V'+1:M | PFM、CFM、PCD 平台 ID |
| M+1：签名 | `SIGN（请求 || 响应）` |


### 恢复固件

启动设备的固件恢复过程。并非所有设备都会
支持所有类型的恢复。实现是特定于设备的。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------------------ ------------------------------|
| 1 | 端口编号 |
| 2 | 要使用的固件映像：0x00 = 退出恢复，0x01 = 进入恢复 |


### 准备恢复镜像

为端口的传入恢复映像提供 RoT。

#### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 端口编号 |
| 2:5 | 总尺寸 |


### 更新恢复镜像

闪存描述符结构描述了设备的闪存区域。

#### 要求

| 有效载荷 | 说明 |
|--------|------------------------|
| 1 | 端口编号 |
| 2:N | 恢复映像负载 |


### 激活恢复映像

信号恢复图像已完全发送并验证图像
应该开始。一旦图像通过验证，它就可以用于主机
固件恢复。

### 要求

| 有效载荷 | 说明 |
|--------|------------|
| 1 | 端口编号 |


### 获取恢复映像 ID

检索恢复映像标识符。

#### 要求

| 有效载荷 | 说明 |
|------------|-------------------------------- --------------------------|
| 1 | 端口编号 |
| 2（可选） | 标识符：0x00 = 版本 ID（默认），0x01 = 平台 ID |

#### 回复

| 有效载荷 | 说明 |
|--------|------------------------------------ --------------|
| 1:N | 恢复映像平台 ID 为空终止 ASCII |


### 获取平台测量寄存器

返回 Cerberus 平台测量寄存器 (PMR)，它是
Cerberus 固件、PFM、CFM 和 PCD。PMR0 中包含的信息是
地狱犬固件。PMR1-2预留给PFM/CFM/PCD等配置。
PMR3-4 保留供外部使用。

认证要求至少维护 PMR0，因为那是
质询响应消息中报告的测量值。至少，PMR0
应包含设备的任何安全配置和所有固件
成分。这包括任何正在运行的固件以及固件
运行以启动设备。为了便于证明，PMR0 旨在
只包含静态信息。如果可变数据也将被测量，这些
测量应通过 PMR1-2 暴露。

#### 要求

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1 | 平台测量编号 |
| 2:33 | 随机数 |

#### 回复

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1:32 | 随机数 |
| 33 | 测量长度 (L) |
| 34:33+左 | 平台测量值 |
| 34+长：中 | `SIGN（请求 ++ 响应）` |

PMR1-4 在组件复位时被清除。PMR0 被清除并在 Cerberus 上重建
重置。


### 更新平台测量寄存器

允许对 PMR3-4 进行外部更新。尝试更新 PMR0-2 将导致
错误。测量扩展仅支持 SHA2。SHA1 和 SHA3 是
不适用。注意：测量值只能更新
经过身份验证和安全的通道。

#### 请求

| 有效载荷 | 说明 |
|--------|----------------------------|
| 1 | 平台测量编号 |
| 2:N | 测量扩展 |


### 重置计数器

自上电以来提供 Cerberus 和组件复位计数器。

#### 要求

| 有效载荷 | 说明 |
|--------|--------------------|
| 1 | 重置计数器类型 |
| 2 | 端口编号 |

可能的重置计数器类型：
* 0x00：本地设备
* 0x01：受保护的外部设备（如果适用）。
    这些不包括设备挑战的外部 AC-RoT。
* 其他值由供应商定义。

#### 回复

| 有效载荷 | 说明 |
|--------|------------|
| 1:2 | 重置计数 |


### 消息解封

此命令开始解封证明消息。密文是有限的
什么可以适合单个消息以及其他必要的部分
启封。

#### 要求

<!-- TODO：让它成为一个合适的表格。-->
<表>
    <tr>
        <td><strong>负载</strong> </td>
        <td><strong>描述</strong> </td>
    </tr>
    <tr>
        <td>1</td>
        <td>[7:5] 保留
            <br> [4:2] HMAC 类型：
            <br> 000 – SHA256
            <br> [1:0] 种子类型：
            <br> 00 – RSA：种子使用 RSA 公钥加密
            <br>01 – ECDH：种子是ECC公钥，ASN.1/DER编码</td>
    </tr>
    <tr>
        <td>2</td>
        <td>额外的种子参数
            <br> 搜索引擎优化：
            <br> [7:3] 保留
            <br> [2:0] 填充方案：
            <br> 000 – PKCS#1 v1.5
            <br> 001 – 使用 SHA1 的 OAEP
            <br> 010 – 使用 SHA256 的 OAEP
            <br>ECDH：
            <br> [7:1] 保留
            <br> [0]: 种子加工:
            <br> 0 – 没有额外的处理。原始 ECDH 输出是种子。
            <br> 1 – 种子是 ECDH 输出的 SHA256 散列。</td>
    </tr>
    <tr>
        <td>3:4</td>
        <td>种子长度（S）</td>
    </tr>
    <tr>
        <td>5:4+S (S')</td>
        <td>种子</td>
    </tr>
    <tr>
        <td>S'+1:S'+2</td>
        <td>密文长度(C)</td>
    </tr>
    <tr>
        <td>S'+3:S'+2+C (C') </td>
        <td>密文</td>
    </tr>
    <tr>
        <td>C'+1:C'+2</td>
        <td>HMAC 长度（H）</td>
    </tr>
    <tr>
        <td>C'+3:C'+2+H (H')</td>
        <td>HMAC</td>
    </tr>
    <tr>
        <td>H'+1:H'+64 (P0')</td>
        <td>PMR0 密封，忽略 0。未使用的字节在前，必须设置为 0。</td>
    </tr>
    <tr>
        <td>P0'+1:P0'+64 (P1')</td>
        <td>PMR1 密封，忽略 0。未使用的字节在前，必须设置为 0。</td>
    </tr>
    <tr>
        <td>P1'+1:P1'+64 (P2')</td>
        <td>PMR2 密封，忽略 0。未使用的字节在前，必须设置为 0。</td>
    </tr>
    <tr>
        <td>P2'+1:P2'+64 (P3')</td>
        <td>PMR3 密封，忽略 0。未使用的字节在前，必须设置为 0。</td>
    </tr>
    <tr>
        <td>P3'+1:P3'+64</td>
        <td>PMR4 密封，忽略 0。未使用的字节在前，必须设置为 0。</td>
    </tr>
</表>


### 消息解封结果

此命令检索解封过程的当前状态。

#### 要求

空的身体。

#### 回复

| 有效载荷 | 说明 |
|--------|------------------|
| 1:4 | 开封状态 |

| 有效载荷 | 说明 |
|--------|------------------------|
| 1:4 | 开封状态 |
| 5:6 | 加密密钥长度 |
| 7:N | 加密密钥 |

Seal/Unseal 流程在 Cerberus 证明集成中进行了描述
规格。


# 平台主动 RoT (PA-RoT)

PA-RoT 负责挑战 AC-RoT 并收集他们的
固件测量。PA-RoT 保留了一份私有清单
组件，包括地址、总线、固件版本、摘要和
固件拓扑。

清单通知 PA-RoT 有关系统中所有活动组件的信息。它
提供他们的 I2C 地址，以及如何验证他们的信息
针对已知或预期状态的测量。中配置的策略
Platform RoT 确定在测量失败时应该采取什么行动
确认。

在 Cerberus 设计的主板中，PA-RoT 协调上电。仅有的
挑战清单中列出的活动组件，通过验证将
从上电复位释放。

## 平台固件清单 (PFM) 和组件固件清单

PA-RoT 包含一个平台固件清单 (PFM)，它描述了
平台允许的固件。组件固件清单 (CFM)
描述平台中组件允许的固件。该平台
Configuration Data (PCD)，具体到每个SKU描述了Component的数量
平台中的类型及其各自的位置。

注意：PFM 和 CFM 不同于
处理器安全启动要求规范。PFM 和 CFM 描述了
允许跨平台和活动组件在系统中运行的固件。
CFM 是 PFM 的补充，由 PA-RoT 为测量生成
系统中组件的比较。这个补充是作为报告
固件清单 (RFM)，类似于 TCG 日志。PFM 和 RFM 被存储
在 PA-RoT 中加密。PA-RoT 的对称加密密钥是
硬件生成并且每个微控制器都是独一无二的。中的对称密钥
PA-Rot 不可导出或固件不可读；并且只能访问加密货币
加密/解密引擎。AES Galois/Counter Mode (GCM) 加密
对应用程序中清单的任何更改的唯一可审核标记
级别和持久存储级别。

下表列出了每个 Active 存储在 PFM 中的属性
成分：

| 属性 | 说明 |
|------------------------|------------------------ ------------------|
| 说明 | 设备部件或说明 |
| 设备类型 | AC-RoT 的底层设备类型 |
| 整治政策 | 完整性失败的补救措施。|
| 固件版本 | 固件版本列表 |
| 闪存区域/偏移 | 偏移量和摘要列表，已使用和未使用 |
| 测量 | 固件测量 |
| 测量算法 | 用于计算测量值的算法。|
| 公钥 | 密钥清单中的公钥。|
| 摘要算法 | 用于计算的算法。|
| 签名 | 固件签名 |

PA-RoT 主动测量来自平台固件的闪存，即 PFM
提供指示 RoT 测量和签名的元数据
确认。PA-RoT 将测量结果存储在 RFM 中。PA-Rot 然后
使用平台配置挑战 AC-RoT 的测量
数据。它将 AC-RoT 的测量值与 CFM 的测量值进行比较，同时记录
RFM 中的测量。

平台固件和组件固件的测量结果与
PFM 和 CFM。如果发生不匹配，PA-RoT 将生成事件日志
并调用为平台和/或组件定义的策略操作。A
对于 PFM/CFM 挑战失败，可以自动执行各种操作。动作
在 CFM 和 PCD 文件中定义。

注意：PA-RoT 和 AC-RoT 强制执行安全启动，并且只允许下载
数字签名和未撤销的固件。PFM 或 CFM 不匹配只会发生
当固件完整性受到质疑时。


## RoT对外通信接口

PA-RoT 通过 SPI、QSPI 连接到平台，具体取决于
母板。虽然 PA-RoT 物理连接到 SPI 总线，但
微处理器对主机来说是透明的，因为它只显示一个闪存
界面。PA-RoT 和 AC-RoT 的管理接口是 I2C 总线
通过底板管理控制器 (BMC) 传送。BMC可达
平台中的所有 AC-RoT。BMC 将 PA-RoT 桥接到机架管理器，
反过来将机架连接到数据中心管理网络。这
PA-RoT 的接口如下：

> TODO：图 12

数据中心管理 (DCM) 软件可以与 PA-RoT 通信
通过机架管理器的带外 (OOB)。机架管理器允许隧道
通过连接到 PA-RoT 的底板管理控制器
通过 I2C。这个通道被认为是不安全的，这就是为什么所有的通信都是
经过身份验证和加密。数据中心管理软件可以收集
通过此安全通道的 RFM 测量和其他挑战数据。安全的
也可以通过此渠道进行更新。


## 主机接口

主机可以通过BMC主机与PA-RoT和AC-RoT进行通信
界面。类似于OOB路径，BMC桥接主机端LPC/eSPI
接口到 RoT 上的 I2C 接口。通过 BMC 的主机是不安全的
通道，因此需要身份验证和机密性。

## 带外 (OOB) 接口

OOB 接口对于报告潜在的固件危害至关重要
在上电期间。如果在开机期间发生固件损坏，则 OOB
当 CPU 处于复位状态时，通道可以与 DCM 软件通信。
如果恢复策略确定系统应保持关闭状态，则
DCM 软件仍然有可能询问 PA-RoT 的详细信息
状态并做出补救措施的决定。

与 Cerberus 的 OOB 通信需要 TLS 和证书身份验证。


# 旧版界面

遗留接口被定义为与设备的向后可兼容性
不支持 MCTP。这些设备必须提供具有特定的寄存器组
设备功能的偏移量，接收别名证书，接受随机数，
并为签名固件测量提供偏移量。载荷
结构将与 MCTP 协议版本紧密匹配。遗产
不支持基于会话的身份验证但允许签名的接口
测量。


## 协议格式

传统协议利用 SMBus 写/读字和块命令。
该接口是基于寄存器的，使用类似的 I2C 读写子程序
设备。数据传输和接收要求为 32 字节或更大。
可以递归地截断和检索大的有效载荷跨越多个
块读取或写入命令。

块读取 SMBUS 命令在 SMBUS 规范中指定。奴隶
地址写入和命令代码字节由主机发送，然后
反复开始，最后读取一个从机地址。主人保持计时
从站以所选数据响应。命令代码字节可以是
考虑寄存器空间。


### PEC处理

SMBus 遗留协议实现可能会利用 8 位 SMBus 数据包错误
检查 (PEC) 交易数据的完整性。PEC 由以下两者计算
每个数据包的发送器和接收器使用 8 位循环冗余校验
(CRC-8) 读或写总线事务。PEC 累积所有字节
在开始条件后发送或接收。

接收到无效 PEC 的 Active RoT 可以选择 NACK 字节
携带不正确的 PEC 值或丢弃交易数据以及任何
进一步的交易（读或写）直到下一个有效的读或写开始
收到交易。


### 消息拆分

该协议支持 Write Block 和 Read Block 命令。标准SMBus
事务限制为 32 字节的数据。预计一些活跃的
具有固有 Cerberus 功能的组件 RoT 可能具有有限的 I2C 消息
缓冲区围绕 SMBus 协议设计，将它们限制为 32 字节。到
克服消息长度的硬件限制，功能寄存器
包括用于确定消息的最大数据包大小的缓冲区大小。
这允许平台的 Active RoT 发送大于 32 字节的消息。
如果 Active Component RoT 只允许 32 字节的数据，则平台的 Active
RoT 可以将读取或写入块分成多个数据包，总计
整个消息。每个段包括递减的数据包号
按顺序标识整个消息的部分。留在
协议长度 每个消息段必须不超过 255 个字节。


### 有效载荷格式

SMBus 写入和读取块的有效载荷部分将封装
本规范中定义的协议。SMBus 启动和停止帧和
ACK/NACK 位条件从规范的这一部分省略了
简化。查看 START 和 STOP 数据包帧的细节和
ACK/NACK 条件参考 SMBus 规范。

写入和读取命令的数据块将封装消息
有效载荷。封装的有效负载包括一个 uint16 寄存器偏移量和数据
部分。


### 注册格式

SMBUS 命令字节索引寄存器，同时额外写入偏移量
寄存器空间内的索引。偏移量和相应的响应是
封装到 I2C 写入和读取块命令的数据部分。这
PA-RoT 始终是 I2C 主机，因此描述了写入和读取命令
从 I2C 主机的角度来看。

某些寄存器可能包含部分或临时数据，而寄存器是
跨多个命令编写。登记册的填写或盖章
可以通过将密封寄存器写入零偏移来执行写入。

下图描述了大型寄存器的寄存器读取访问流程
空间：

> 待办事项：图 14

下图描述了大型寄存器的寄存器写入访问流程
空间，需要密封（更新完成位）：

> TODO：图 15


### 遗留活动组件 RoT 命令

下表描述了 Active Component RoT 接受的命令。
所有命令均由主机启动。命令号不代表
一个连续的内存空间，但是一个指向相应寄存器的索引

| 注册名称 | 命令 | 长度 | 读/写 | 说明 |
|--------------------------------|--------|----- ---|-----|---------------------------------------- --------------|
| 状态 | 0x30 | 2 | 右 | 命令状态 |
| 固件版本 | 0x32 | 16 | 读/写 | 检索固件版本信息 |
| 设备编号 | 0x33 | 8 | 右 | 检索设备 ID |
| 能力 | 0x34 | 9 | 右 | 检索设备功能 |
| 证书文摘 | 0x3c | 32 | 右 | 设备 ID 证书的 SHA256 |
| 证书 | 0x3d | 4096 | 读/写 | AC-Rot 证书 |
| 挑战 | 0x3e | 32 | 瓦 | RoT 编写的 Nonce |
| 平台配置注册 | 0x03 | 0x5e | 右 | 读取固件测量值，使用 S Nonce | 计算


### 遗留命令格式

以下部分描述了 AC-RoT 的寄存器格式，不
实施 SMBUS 并遵守传统测量交换协议。

#### 地位

SMBUS 读取命令读取有关错误状态的详细信息。现状
在写入挑战随机数和读取随机数之间发出寄存器
测量。推导测量的延迟时间必须符合
能力命令。

| 有效载荷 | 说明 |
|--------|------------------------------------ ------------------|
| 1 | 状态：0x00 = 完成，0x01 = 进行中，0x02 = 错误 |
| 2 | 错误数据或零 |

<!-- 注意：下面的所有表格引用均已损坏并被替换
     使用适当的锚链接。-->

#### 固件版本

SMBUS 写命令负载设置索引。随后的 SMBUS 读取
命令读取响应。有关寄存器有效负载描述，请参阅响应：
表 11 固件版本响应

#### 设备ID

SMBUS 读取命令读取响应。用于寄存器有效负载
说明见回复：表 1 字段定义。

#### 设备能力

SMBUS 读取命令读取响应。有关寄存器有效载荷的描述，请参见
响应：表 13 设备能力响应

#### 证书摘要

SMBUS 读取命令读取响应。对于寄存器有效载荷描述
请参阅响应：表 24 `GET DIGEST` 响应

PA-Rot 将使用摘要来确定它是否已经拥有证书
缓存。与 MCTP 不同，仅支持别名和设备 ID 证书。
因此，它必须由相互信任的 CA 签名，作为 CA Public Cert
不存在

#### 证书

SMBUS 写命令将偏移量写入寄存器空间。注册
有效载荷描述见响应：表 26 `GET CERTIFICATE` 响应

与 MCTP 不同，仅支持别名和设备 ID 证书。所以，
它必须是由相互信任的 CA 签名的 CA，因为 CA 公共证书不是
存在于减少的挑战中

SMBUS 写入命令为测量新鲜度写入随机数。

| 有效载荷 | 说明 |
|--------|------------------------------------ |
| 1:32 | PA-RoT 选择的随机 32 字节随机数 |

#### 测量

SMBUS 读取命令，它从
上面的挑战。PA-RoT 必须在完成后轮询状态寄存器
发出挑战并在阅读测量之前。

| 有效载荷 | 说明 |
|--------|------------------------------------|
| 1 | 以下散列摘要的长度 (L)。|
| 2:33 | `H(挑战随机数 ** H(PMR0))` |
| 34:N | 哈希签名 [2:33] |


# 参考
1. DICE架构
    <https://trustedcomputinggroup.org/work-groups/dice-architectures>
2. 暴动
    <https://www.microsoft.com/en-us/research/publication/riot-a-foundation-for-trust-in-the-internet-of-things>
3. DICE 和 RIoT 密钥和证书
    <https://www.microsoft.com/en-us/research/publication/device-identity-dice-riot-keys-certificates>
4. USB Type C认证规范
    <http://www.usb.org/developers/docs>
5. PCIe 设备安全增强规范
    <https://www.intel.com/content/www/us/en/io/pci-express/pcie-device-security-enhancements-spec.html>
6. NIST 特别出版物 800-108 - 使用伪随机函数推导密钥的建议。
    <http://nvlpubs.nist.gov/nistpubs/Legacy/SP/nistspecialpublication800-108.pdf>
7. TCG PC客户端平台固件配置文件规范
    <https://trustedcomputinggroup.org/resource/pc-client-specific-platform-firmware-profile-specification>